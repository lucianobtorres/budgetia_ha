============================= test session starts =============================
platform win32 -- Python 3.11.6, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\lucia\AppData\Local\pypoetry\Cache\virtualenvs\budgetia-5JwWV8aV-py3.11\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\lucia\Documents\Projetos\Python\BudgetIA\BudgetIA
configfile: pyproject.toml
plugins: anyio-4.11.0, langsmith-0.4.42, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 7 items

tests/initialization/onboarding/test_orchestrator.py::test_initial_state PASSED [ 14%]
tests/initialization/onboarding/test_orchestrator.py::test_welcome_conversation PASSED [ 28%]
tests/initialization/onboarding/test_orchestrator.py::test_welcome_transition_command PASSED [ 42%]
tests/initialization/onboarding/test_orchestrator.py::test_acquisition_conversation PASSED [ 57%]
tests/initialization/onboarding/test_orchestrator.py::test_default_spreadsheet_flow FAILED [ 71%]
tests/initialization/onboarding/test_orchestrator.py::test_ui_options PASSED [ 85%]
tests/initialization/onboarding/test_orchestrator.py::test_strategy_skip_flow PASSED [100%]

================================== FAILURES ===================================
________________________ test_default_spreadsheet_flow ________________________

orchestrator = <initialization.onboarding.orchestrator.OnboardingOrchestrator object at 0x0000021B010C17D0>

    def test_default_spreadsheet_flow(orchestrator):
        # Engage in WELCOME first
        # orchestrator.process_user_input("sim") # Trigger
        # orchestrator.process_user_input("sim") # Confirm
        # NOTE: Default spreadsheet now SKIPS translation review!
        # So we are already in OPTIONAL_PROFILE
    
        # AþÒo: Simular que o agente ofereceu uma estratÚgia e o usußrio aceitou
        # Primeiro, o agente oferece a estratÚgia (simulado via _last_agent_response)
        orchestrator._last_agent_response = "Aqui estß uma sugestÒo de estratÚgia para vocÛ."
    
        # O usußrio aceita
        response = orchestrator.process_user_input("Aceitar sugestÒo")
    
        # Verificaþ§es
>       assert orchestrator.get_current_state() == OnboardingState.COMPLETE
E       assert <OnboardingState.WELCOME: 1> == <OnboardingState.COMPLETE: 6>
E        +  where <OnboardingState.WELCOME: 1> = get_current_state()
E        +    where get_current_state = <initialization.onboarding.orchestrator.OnboardingOrchestrator object at 0x0000021B010C17D0>.get_current_state
E        +  and   <OnboardingState.COMPLETE: 6> = OnboardingState.COMPLETE

tests\initialization\onboarding\test_orchestrator.py:189: AssertionError
---------------------------- Captured stdout setup ----------------------------
[ONBOARDING] Invalid saved status '<MagicMock name='mock.get_onboarding_status()' id='2315004870032'>'. Starting fresh.
---------------------------- Captured stdout call -----------------------------

[ONBOARDING] State=WELCOME | User Input: 'Aceitar sugestÒo' | Clean: 'aceitar sugestÒo'
[ONBOARDING] Intent Detected: POSITIVE_CONFIRMATION
[ONBOARDING] User engaged in WELCOME (intent: POSITIVE_CONFIRMATION)
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.11.6-final-0 _______________\n\nName                                                       Stmts   Miss  Cover   Missing\n----------------------------------------------------------------------------------------\nsrc\\__init__.py                                                0      0   100%\nsrc\\agent_implementations\\__init__.py                          0      0   100%\nsrc\\agent_implementations\\factory.py                           9      9     0%   1-22\nsrc\\agent_implementations\\langchain_agent.py                  73     73     0%   3-162\nsrc\\app\\__init__.py                                            0      0   100%\nsrc\\app\\chat_history_manager.py                               47     47     0%   2-79\nsrc\\app\\chat_service.py                                       34     34     0%   4-85\nsrc\\app\\notification_sender.py                                18     18     0%   2-33\nsrc\\app\\notifications\\__init__.py                              0      0   100%\nsrc\\app\\notifications\\channels\\__init__.py                     0      0   100%\nsrc\\app\\notifications\\channels\\base_channel.py                17     17     0%   2-66\nsrc\\app\\notifications\\channels\\telegram_channel.py            32     32     0%   2-90\nsrc\\app\\notifications\\models\\__init__.py                       0      0   100%\nsrc\\app\\notifications\\models\\notification_message.py          15     15     0%   2-27\nsrc\\app\\notifications\\models\\rule_result.py                   13     13     0%   2-32\nsrc\\app\\notifications\\orchestrator.py                         64     64     0%   2-163\nsrc\\app\\notifications\\rules\\__init__.py                        0      0   100%\nsrc\\app\\notifications\\rules\\base_rule.py                      12     12     0%   2-52\nsrc\\app\\notifications\\rules\\transport_missing_rule.py         27     27     0%   2-104\nsrc\\app\\notifications\\services\\__init__.py                     0      0   100%\nsrc\\app\\proactive_jobs.py                                     34     34     0%   2-108\nsrc\\bot.py                                                    87     87     0%   2-174\nsrc\\config.py                                                112      6    95%   58-66, 72\nsrc\\core\\__init__.py                                           0      0   100%\nsrc\\core\\agent_runner_interface.py                            20     20     0%   2-47\nsrc\\core\\base_tool.py                                         10     10     0%   2-17\nsrc\\core\\cache_service.py                                     97     85    12%   18-31, 35, 44-64, 70-103, 107-114, 123-143, 153-186\nsrc\\core\\google_auth_service.py                              147    117    20%   62-77, 81-89, 96-170, 174-188, 195-228, 235-267, 276-283, 293-335, 343-365\nsrc\\core\\llm_enums.py                                          3      3     0%   1-9\nsrc\\core\\llm_factory.py                                       14     14     0%   2-36\nsrc\\core\\llm_manager.py                                       49     33    33%   22-28, 33, 38, 43, 51-79, 83-85, 90-94\nsrc\\core\\llm_providers\\base_provider.py                       18      9    50%   16-28, 34, 38\nsrc\\core\\user_config_service.py                              158    127    20%   15-19, 30-42, 46, 50, 54-63, 67-91, 95-105, 111-135, 139-148, 151-152, 156-163, 166-167, 170-172, 176-177, 182-183, 186-188, 193-195, 199-200, 204-206, 210-212, 219-245, 252-264\nsrc\\finance\\__init__.py                                        0      0   100%\nsrc\\finance\\factory.py                                        68     44    35%   33-51, 67-143\nsrc\\finance\\financial_rules.py                                12     12     0%   4-57\nsrc\\finance\\planilha_manager.py                               51     31    39%   37-47, 50, 53, 56, 67-70, 73, 76, 85-92, 95, 108, 127, 136, 139, 142, 145-146, 149-150, 153-156\nsrc\\finance\\repositories\\budget_repository.py                 41     31    24%   27-30, 40-102, 109-121\nsrc\\finance\\repositories\\data_context.py                      55     44    20%   35-47, 53-83, 89-91, 97-100, 108-125\nsrc\\finance\\repositories\\debt_repository.py                   39     31    21%   32-34, 51-120\nsrc\\finance\\repositories\\insight_repository.py                14      8    43%   23-24, 35-61\nsrc\\finance\\repositories\\profile_repository.py                70     59    16%   27-28, 32, 39-72, 79-112, 120-158\nsrc\\finance\\repositories\\transaction_repository.py            25     14    44%   28-30, 34, 48-76, 80-81, 85-86\nsrc\\finance\\schemas.py                                        56     56     0%   1-167\nsrc\\finance\\services\\budget_service.py                        46     41    11%   22-128\nsrc\\finance\\services\\debt_service.py                          15     12    20%   23-43\nsrc\\finance\\services\\insight_service.py                       40     29    28%   29-31, 37-91, 98-130\nsrc\\finance\\services\\setup_service.py                         29     21    28%   33-36, 40-57, 60-75, 83-105\nsrc\\finance\\services\\transaction_service.py                   29     24    17%   19-59, 72-97\nsrc\\finance\\storage\\base_storage_handler.py                   16      4    75%   35, 48, 56, 65\nsrc\\finance\\strategies\\base_strategy.py                       27     15    44%   27-29, 44, 58, 64-67, 74-83\nsrc\\finance\\strategies\\default_strategy.py                    21     13    38%   21-22, 31-52, 60-65\nsrc\\finance\\tool_loader.py                                    49     49     0%   2-114\nsrc\\finance\\tools\\__init__.py                                  0      0   100%\nsrc\\finance\\tools\\add_debt_tool.py                            19     19     0%   2-56\nsrc\\finance\\tools\\add_transaction_tool.py                     38     38     0%   2-90\nsrc\\finance\\tools\\analyze_adherence_tool.py                   55     55     0%   2-107\nsrc\\finance\\tools\\analyze_debt_tool.py                        42     42     0%   2-88\nsrc\\finance\\tools\\analyze_spending_trends_tool.py             36     36     0%   2-70\nsrc\\finance\\tools\\calculate_balance_tool.py                   20     20     0%   2-42\nsrc\\finance\\tools\\calculate_expenses_by_category_tool.py      24     24     0%   2-48\nsrc\\finance\\tools\\check_budget_status_tool.py                 33     33     0%   2-81\nsrc\\finance\\tools\\collect_user_profile_tool.py                19     19     0%   2-43\nsrc\\finance\\tools\\define_budget_tool.py                       19     19     0%   2-51\nsrc\\finance\\tools\\extract_transactions_tool.py                12     12     0%   2-28\nsrc\\finance\\tools\\generate_monthly_summary_tool.py            52     52     0%   2-85\nsrc\\finance\\tools\\identify_top_expenses_tool.py               32     32     0%   2-64\nsrc\\finance\\tools\\recommend_rule_tool.py                      36     36     0%   2-66\nsrc\\finance\\tools\\register_ai_insight_tool.py                 19     19     0%   2-50\nsrc\\finance\\tools\\view_data_tool.py                           24     24     0%   2-43\nsrc\\finance\\tools\\view_debts_tool.py                          18     18     0%   2-35\nsrc\\finance\\tools\\visualizar_ultimas_transacoes_tool.py       40     40     0%   2-92\nsrc\\finance\\utils.py                                          11      8    27%   8-17\nsrc\\initialization\\__init__.py                                 0      0   100%\nsrc\\initialization\\file_preparer.py                           72     72     0%   2-144\nsrc\\initialization\\onboarding\\__init__.py                      0      0   100%\nsrc\\initialization\\onboarding\\agent.py                        47     36    23%   20-23, 27-48, 60-95, 99\nsrc\\initialization\\onboarding\\analyzers.py                    89     50    44%   46, 52-89, 100-118, 143, 152-206\nsrc\\initialization\\onboarding\\file_handlers.py               111     84    24%   27, 40, 51-71, 75-193, 208-227, 230-257, 275-294, 298-340\nsrc\\initialization\\onboarding\\orchestrator.py                310    173    44%   65, 71, 110, 118-140, 174-175, 194-220, 236-238, 243-318, 328-337, 341-345, 361-372, 401, 422-427, 462-473, 483-639, 662, 666-671, 674, 680, 684, 688, 691, 693-695, 706-707, 720-728, 731\nsrc\\initialization\\onboarding\\state_machine.py                30      5    83%   84, 103-106, 111-119\nsrc\\initialization\\strategy_generator.py                     159    130    18%   31-35, 45-46, 50-74, 78-99, 103-104, 113-207, 215-224, 234, 245-323\nsrc\\initialization\\system_initializer.py                      42     42     0%   2-81\nsrc\\main.py                                                   39     39     0%   1-76\nsrc\\scheduler.py                                              55     55     0%   2-101\nsrc\\web_app\\__init__.py                                        0      0   100%\nsrc\\web_app\\utils.py                                         184    184     0%   2-356\nsrc\\web_app\\\U0001f4b0_BudgetIA.py                                    105    105     0%   2-171\n----------------------------------------------------------------------------------------\nTOTAL                                                       3605   2965    18%\n=========================== short test summary info ===========================
FAILED tests/initialization/onboarding/test_orchestrator.py::test_default_spreadsheet_flow - assert <OnboardingState.WELCOME: 1> == <OnboardingState.COMPLETE: 6>
 +  where <OnboardingState.WELCOME: 1> = get_current_state()
 +    where get_current_state = <initialization.onboarding.orchestrator.OnboardingOrchestrator object at 0x0000021B010C17D0>.get_current_state
 +  and   <OnboardingState.COMPLETE: 6> = OnboardingState.COMPLETE
========================= 1 failed, 6 passed in 2.46s =========================
